/**
 * @license
 * Created by Karina Romero on 30/06/2016.
 * Copyright Â© 2016 Sandcode Software S.A. de C.V. All rights reserved.
 */
function send(e){connectedUser&&(e.name=connectedUser),connection.send(JSON.stringify(e))}function onLogin(e){e===!1?alert("Login unsuccessful, please try a different name."):(loginPage.style.display="none",callPage.style.display="block",startConnection())}function onOffer(e,n){connectedUser=n,yourConnection.setRemoteDescription(new RTCSessionDescription(e)),yourConnection.createAnswer(function(e){yourConnection.setLocalDescription(e),send({type:"answer",answer:e})},function(e){alert(e)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),console.log(yourConnection)}function onAnswer(e){console.log("SDP",e),yourConnection.setRemoteDescription(new RTCSessionDescription(e))}function onCandidate(e){yourConnection.addIceCandidate(new RTCIceCandidate(e))}function onLeave(){connectedUser=null,theirVideo.src=null,yourConnection.close(),yourConnection.onicecandidate=null,yourConnection.onaddstream=null,setupPeerConnection(stream),console.log("onLeave",stream.toString())}function hasUserMedia(){return!!(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}function hasRTCPeerConnection(){return window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCSessionDescription=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription,window.RTCIceCandidate=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate,!!window.RTCPeerConnection}function startConnection(){hasUserMedia()?navigator.getUserMedia({video:!0,audio:!1},function(e){stream=e,yourVideo.src=window.URL.createObjectURL(stream),hasRTCPeerConnection()?setupPeerConnection(stream):alert("Sorry, your browser does not support WebRTC. ")},function(e){console.log(e)}):alert("Sorry, your browser does not support WebRTC. ")}function setupPeerConnection(e){console.log(e);var n={iceServers:[{url:"stun:stun.1.google.com:19302"}]};yourConnection=new RTCPeerConnection(n),yourConnection.addStream(e),yourConnection.onaddstream=function(e){console.log(e.stream),theirVideo.src=window.URL.createObjectURL(e.stream)},yourConnection.onicecandidate=function(e){e.candidate&&send({type:"candidate",candidate:e.candidate})}}function startPeerConnection(e){connectedUser=e,yourConnection.createOffer(function(e){send({type:"offer",offer:e}),yourConnection.setLocalDescription(e)},function(e){alert("An error has ocurred.")})}var name="",connectedUser,connection=new WebSocket("ws://162.243.206.15:8888"),loginPage=document.querySelector("#login-page"),usernameInput=document.querySelector("#username"),loginButton=document.querySelector("#login"),callPage=document.querySelector("#call-page"),theirUsernameInput=document.querySelector("#their-username"),callButton=document.querySelector("#call"),hangUpButton=document.querySelector("#hang-up");callPage.style.display="none",loginButton.addEventListener("click",function(e){name=usernameInput.value,name.length>0&&send({type:"login",name:name})}),connection.onopen=function(){console.log("Connected")},connection.onmessage=function(e){console.log("Got menssge",e.data);var n=JSON.parse(e.data);switch(n.type){case"login":onLogin(n.success);break;case"offer":onOffer(n.offer,n.name);break;case"answer":onAnswer(n.answer),console.log("onAnswer: ",n.answer);break;case"candidate":onCandidate(n.candidate);break;case"leave":onLeave()}},connection.onerror=function(e){console.log("Got error",e)},callButton.addEventListener("click",function(){var e=theirUsernameInput.value;e.length>0&&startPeerConnection(e)}),hangUpButton.addEventListener("click",function(){send({type:"leave"}),onLeave()});var yourVideo=document.querySelector("#yours"),theirVideo=document.querySelector("#theirs"),yourConnection,connectedUser,stream;